FROM centos:7

MAINTAINER Red Hat, Inc. <container-tools@redhat.com>

# Check https://bodhi.fedoraproject.org/updates/?packages=atomicapp
# for the most recent builds of atomicapp in epel
ENV ATOMICAPPVERSION="0.5.0"
ENV TESTING="--enablerepo=epel-testing"

LABEL io.projectatomic.nulecule.atomicappversion=${ATOMICAPPVERSION} \
      io.openshift.generate.job=true \
      io.openshift.generate.token.as=env:TOKEN_ENV_VAR \
      RUN="docker run -it --rm \${OPT1} --privileged -v \${PWD}:/atomicapp -v /var/run:/var/run -v /var/lock:/var/lock -v /:/host --net=host --name \${NAME} -e NAME=\${NAME} -e IMAGE=\${IMAGE} \${IMAGE} -v \${OPT2} run \${OPT3} \${IMAGE}" \
      STOP="docker run -it --rm \${OPT1} --privileged -v \${PWD}:/atomicapp -v /var/run:/var/run -v /var/lock:/var/lock -v /:/host --net=host --name \${NAME} -e NAME=\${NAME} -e IMAGE=\${IMAGE} \${IMAGE} -v \${OPT2} stop \${OPT3}" \

WORKDIR /atomicapp

# If a volume doesn't get mounted over /atomicapp (like when running in 
# an openshift pod) then open up permissions so files can be copied into
# the directory by non-root.
RUN chmod 777 /atomicapp

# If a volume doesn't get mounted over /var/lock (like when running in an
# openshift pod) then open up permissions so the lock file can be
# created by non-root.
RUN chmod 777 /var/lock

RUN yum install -y epel-release && \
    yum install -y atomicapp-${ATOMICAPPVERSION} ${TESTING} --setopt=tsflags=nodocs && \
    yum clean all

# the entrypoint
ENTRYPOINT ["/usr/bin/atomicapp"]
